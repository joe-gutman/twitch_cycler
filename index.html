<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Channel Cycler</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #18181b;
            color: #efeff1;
        }
        
        #controls {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #0e0e10;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 1000;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            grid-template-rows: auto auto;
            align-items: center;
            gap: 15px;
            min-height: 70px;
        }
        
        #channelName {
            font-size: 20px;
            font-weight: bold;
            color: #9147ff;
            flex: 1;
            min-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .live-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #53fc18;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .offline-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #464649;
            margin-right: 8px;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        #streamInfo {
            font-size: 12px;
            color: #adadb8;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 400px;
        }
        
        #liveCount {
            background-color: #53fc18;
            color: #0e0e10;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        button {
            background-color: #9147ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        button:hover {
            background-color: #772ce8;
        }
        
        button:disabled {
            background-color: #464649;
            cursor: not-allowed;
        }
        
        input[type="number"] {
            background-color: #464649;
            color: #efeff1;
            border: 1px solid #772ce8;
            padding: 8px;
            border-radius: 4px;
            width: 80px;
        }
        
        input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        
        input[type="text"] {
            background-color: #464649;
            color: #efeff1;
            border: 1px solid #772ce8;
            padding: 8px;
            border-radius: 4px;
            width: 300px;
        }
        
        label {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #iframe-container {
            position: fixed;
            top: 100px;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        #progress {
            width: 100%;
            height: 4px;
            background-color: #464649;
            border-radius: 2px;
            overflow: hidden;
        }
        
        #progressBar {
            height: 100%;
            background-color: #9147ff;
            width: 0%;
            transition: width 0.5s linear;
        }
        
        #manageBtnContainer {
            position: relative;
            margin-left: auto;
        }
        
        #managePanel {
            position: fixed;
            top: 70px;
            right: 15px;
            background-color: #0e0e10;
            border: 1px solid #772ce8;
            border-radius: 4px;
            padding: 15px;
            width: 350px;
            height: 500px;
            min-height: 200px;
            overflow-y: auto;
            resize: vertical;
            z-index: 2000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        #managePanel.hidden {
            display: none;
        }
        
        #managePanel h3 {
            margin: 0 0 15px 0;
            color: #9147ff;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .close-panel-btn {
            background-color: transparent;
            color: #adadb8;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .close-panel-btn:hover {
            color: #efeff1;
        }
        
        .add-streamer-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #464649;
        }
        
        .add-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .add-input-group input {
            flex: 1;
            background-color: #464649;
            color: #efeff1;
            border: 1px solid #772ce8;
            padding: 8px;
            border-radius: 4px;
        }
        
        .add-btn {
            background-color: #53fc18;
            color: #0e0e10;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .add-btn:hover {
            background-color: #45d314;
        }
        
        .bulk-paste-area {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            background-color: #464649;
            color: #efeff1;
            border: 1px solid #772ce8;
            padding: 8px;
            border-radius: 4px;
            resize: vertical;
            font-family: monospace;
            font-size: 12px;
        }
        
        .streamer-list {
            margin-top: 15px;
        }
        
        .streamer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            background-color: #1f1f23;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        
        .streamer-item:hover {
            background-color: #2a2a2e;
        }
        
        .streamer-name {
            flex: 1;
            color: #efeff1;
        }
        
        .streamer-name:hover {
            color: #9147ff;
            text-decoration: underline;
        }
        
        .delete-btn {
            background-color: #ff6b6b;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .delete-btn:hover {
            background-color: #ff5252;
        }
    </style>
</head>
<body>
    <div id="controls">
        <div style="grid-column: 1; display: flex; align-items: center; gap: 15px;">
            <div style="min-width: 200px;">
                <div id="channelName">Loading...</div>
                <div id="streamInfo"></div>
            </div>
            <div id="liveCount" style="display: none;">0 LIVE</div>
        </div>
        
        <div style="grid-column: 2; display: flex; gap: 15px;">
            <button id="prevBtn" onclick="previousChannel()">‚óÄ Previous</button>
            <button id="playPauseBtn" onclick="togglePlayPause()">‚è∏ Pause</button>
            <button id="nextBtn" onclick="nextChannel()">Next ‚ñ∂</button>
        </div>
        
        <div style="grid-column: 3; display: flex; gap: 15px; justify-content: flex-end;">
            <div id="manageBtnContainer">
                <button onclick="toggleManagePanel()">‚öôÔ∏è Settings</button>
                
                <!-- Settings Panel -->
                <div id="managePanel" class="hidden">
                <h3>
                    <span>Settings</span>
                    <button class="close-panel-btn" onclick="toggleManagePanel()">‚úï</button>
                </h3>
                
                <div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <input type="checkbox" id="liveOnlyCheckbox" onchange="toggleLiveOnly()" checked>
                            Live channels only
                        </label>
                        
                        <label style="display: flex; align-items: center; gap: 8px;">
                            Interval (seconds):
                            <input type="number" id="intervalInput" value="30" min="5" max="600" onchange="updateInterval()">
                        </label>
                    </div>
                    
                    <div style="border-top: 1px solid #464649; margin-top: 15px;">
                        <div style="background-color: #9147ff; color: white; font-weight: bold; padding: 10px; text-align: center; margin: 0 -15px; margin-bottom: 15px;">Manage Streamers</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div class="add-input-group">
                        <input type="text" id="streamerInput" placeholder="Enter streamer name..." />
                        <button class="add-btn" onclick="addStreamer()">+ Add</button>
                    </div>
                    
                    <div style="margin-bottom: 10px; color: #adadb8; font-size: 12px;">Or paste comma-separated list:</div>
                    <textarea class="bulk-paste-area" id="bulkPasteArea" rows="3" placeholder="streamer1, streamer2, streamer3"></textarea>
                    <button class="add-btn" onclick="bulkAddStreamers()" style="margin-top: 8px; width: 100%;">Add All from List</button>
                </div>
                
                <div class="streamer-list" id="streamerList"></div>
                </div>
            </div>
        </div>
        
        <div id="progress" style="grid-column: 1 / -1;">
            <div id="progressBar"></div>
        </div>
    </div>
    
    <div id="iframe-container">
        <iframe id="twitchFrame" src="" allowfullscreen></iframe>
    </div>

    <script>
        // Load streamers from localStorage or use defaults
        let streamers = JSON.parse(localStorage.getItem('customStreamers')) || [
            "AdamRoguezy",
            "ADarkLegacy",
            "aksually",
            "ARCHIT3CT",
            "ashleyroboto",
            "banthony",
            "blizz",
            "BobbyBurm",
            "butteryflaky",
            "bwick",
            "Carla",
            "cheebs",
            "chiblee",
            "chrismelberger",
            "ChrispyGameplay",
            "Crub",
            "detune",
            "dudlik",
            "EthanNestor",
            "hankstergirl",
            "hanner",
            "JessCapricorn",
            "johnchoi",
            "LeoSypniewski",
            "Loganolio",
            "Michael_Lopriore",
            "nandre",
            "PapaHogsPalaceOfPleasure",
            "PointCrow",
            "prezoh",
            "sandy",
            "Shaggedy",
            "Skootish",
            "vaqrgaming",
            "vixella",
            "whisqey"
        ];
        
        // Auto-detect domain for Twitch embed parent parameter
        const currentDomain = window.location.hostname;
        
        let currentIndex = 0;
        let isPlaying = true;
        let intervalId = null;
        let progressIntervalId = null;
        let intervalSeconds = 30;
        let streamStatus = {};
        let liveOnlyMode = true;
        let activeStreamers = [...streamers];
        let isMuted = false;
        let isInFullscreen = false;
        
        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('muteBtn');
            
            if (isMuted) {
                btn.textContent = 'üîá Muted';
            } else {
                btn.textContent = 'üîä Unmuted';
            }
            
            // Reload current channel with new mute state
            loadChannel(currentIndex);
        }
        
        function toggleManagePanel() {
            const panel = document.getElementById('managePanel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                renderStreamerList();
            }
        }
        
        // Close panel when clicking outside
        document.addEventListener('click', function(event) {
            const panel = document.getElementById('managePanel');
            const container = document.getElementById('manageBtnContainer');
            
            if (!panel.classList.contains('hidden') && 
                !container.contains(event.target)) {
                panel.classList.add('hidden');
            }
        });
        
        function saveStreamers() {
            localStorage.setItem('customStreamers', JSON.stringify(streamers));
            activeStreamers = liveOnlyMode ? 
                streamers.filter(s => streamStatus[s]?.live) : 
                [...streamers];
            
            // Reset to first channel if current index is out of bounds
            if (currentIndex >= activeStreamers.length) {
                currentIndex = 0;
            }
            
            // Refresh stream status with new list
            fetchStreamStatus();
        }
        
        function addStreamer() {
            const input = document.getElementById('streamerInput');
            const name = input.value.trim();
            
            if (!name) {
                alert('Please enter a streamer name');
                return;
            }
            
            if (streamers.includes(name)) {
                alert('Streamer already in list');
                return;
            }
            
            streamers.push(name);
            saveStreamers();
            renderStreamerList();
            input.value = '';
        }
        
        function bulkAddStreamers() {
            const textarea = document.getElementById('bulkPasteArea');
            const names = textarea.value
                .split(',')
                .map(s => s.trim())
                .filter(s => s.length > 0);
            
            if (names.length === 0) {
                alert('Please enter at least one streamer name');
                return;
            }
            
            let added = 0;
            names.forEach(name => {
                if (!streamers.includes(name)) {
                    streamers.push(name);
                    added++;
                }
            });
            
            if (added > 0) {
                saveStreamers();
                renderStreamerList();
                textarea.value = '';
                alert(`Added ${added} streamer(s)`);
            } else {
                alert('All streamers are already in the list');
            }
        }
        
        function removeStreamer(name) {
            streamers = streamers.filter(s => s !== name);
            saveStreamers();
            renderStreamerList();
        }
        
        function loadStreamerByName(name) {
            // Find the streamer in the active list
            const index = activeStreamers.indexOf(name);
            if (index !== -1) {
                currentIndex = index;
                loadChannel(currentIndex);
            } else {
                // If not in active list (maybe filtered by live-only), turn off filter and load
                liveOnlyMode = false;
                document.getElementById('liveOnlyCheckbox').checked = false;
                activeStreamers = [...streamers];
                currentIndex = streamers.indexOf(name);
                if (currentIndex !== -1) {
                    loadChannel(currentIndex);
                }
            }
        }
        
        function renderStreamerList() {
            const container = document.getElementById('streamerList');
            container.innerHTML = '<div style="margin-bottom: 10px; color: #adadb8; font-size: 12px;">Current Streamers (' + streamers.length + '):</div>';
            
            streamers.forEach((name, index) => {
                const item = document.createElement('div');
                item.className = 'streamer-item';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'streamer-name';
                nameSpan.textContent = name;
                nameSpan.style.cursor = 'pointer';
                nameSpan.onclick = () => loadStreamerByName(name);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeStreamer(name);
                };
                
                item.appendChild(nameSpan);
                item.appendChild(deleteBtn);
                container.appendChild(item);
            });
        }
        
        async function fetchStreamStatus() {
            try {
                // Call our Netlify serverless function instead of Twitch API directly
                // This keeps our OAuth token secure in environment variables
                const streamersParam = streamers.join(',');
                const url = `/.netlify/functions/streams?streamers=${encodeURIComponent(streamersParam)}`;
                
                console.log('Fetching stream status from Netlify function...');
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Stream API error:', errorData);
                    
                    if (errorData.error && errorData.error.includes('not configured')) {
                        console.error('‚ö†Ô∏è Twitch credentials not set in Netlify environment variables');
                        console.error('Go to: Site settings > Environment variables');
                        console.error('Add: TWITCH_CLIENT_ID and TWITCH_OAUTH_TOKEN');
                    }
                    return;
                }
                
                streamStatus = await response.json();
                console.log('Stream status updated:', Object.values(streamStatus).filter(s => s.live).length, 'channels live');
                
                updateLiveCount();
                updateStreamInfo();
            } catch (error) {
                console.error('Error fetching stream status:', error);
            }
        }
        
        function updateLiveCount() {
            const liveStreams = Object.values(streamStatus).filter(s => s.live).length;
            const liveCountEl = document.getElementById('liveCount');
            
            if (liveStreams > 0) {
                liveCountEl.textContent = `${liveStreams} LIVE`;
                liveCountEl.style.display = 'block';
            } else {
                liveCountEl.style.display = 'none';
            }
        }
        
        function updateStreamInfo() {
            const streamer = activeStreamers[currentIndex];
            const status = streamStatus[streamer];
            const streamInfoEl = document.getElementById('streamInfo');
            
            if (!status) {
                streamInfoEl.textContent = '';
                return;
            }
            
            if (status.live) {
                const game = status.game ? ` ‚Ä¢ ${status.game}` : '';
                const viewers = status.viewers ? ` ‚Ä¢ ${status.viewers.toLocaleString()} viewers` : '';
                streamInfoEl.innerHTML = `<span class="live-indicator"></span>${status.title || 'Live'}${game}${viewers}`;
            } else {
                streamInfoEl.innerHTML = `<span class="offline-indicator"></span>Offline`;
            }
        }
        
        function toggleLiveOnly() {
            liveOnlyMode = document.getElementById('liveOnlyCheckbox').checked;
            
            if (liveOnlyMode) {
                // Filter to only live channels
                const liveStreamers = streamers.filter(s => streamStatus[s]?.live);
                
                if (liveStreamers.length === 0) {
                    alert('No channels are currently live!');
                    document.getElementById('liveOnlyCheckbox').checked = false;
                    liveOnlyMode = false;
                    return;
                }
                
                activeStreamers = liveStreamers;
                currentIndex = 0;
            } else {
                // Show all channels
                activeStreamers = [...streamers];
                currentIndex = streamers.indexOf(activeStreamers[0]);
            }
            
            loadChannel(currentIndex);
        }
        
        function loadChannel(index) {
            const streamer = activeStreamers[index];
            const iframe = document.getElementById('twitchFrame');
            const iframeContainer = document.getElementById('iframe-container');
            const channelName = document.getElementById('channelName');
            
            // Use auto-detected domain for Twitch embed
            const muteParam = isMuted ? '&muted=true' : '&muted=false';
            iframe.src = `https://player.twitch.tv/?channel=${streamer}&parent=${currentDomain}${muteParam}&autoplay=true`;
            channelName.textContent = `${index + 1}/${activeStreamers.length}: ${streamer}`;
            
            // Re-enter fullscreen after iframe loads if we were in fullscreen
            if (isInFullscreen) {
                iframe.onload = function() {
                    setTimeout(() => {
                        if (iframeContainer.requestFullscreen) {
                            iframeContainer.requestFullscreen();
                        } else if (iframeContainer.webkitRequestFullscreen) {
                            iframeContainer.webkitRequestFullscreen();
                        } else if (iframeContainer.mozRequestFullScreen) {
                            iframeContainer.mozRequestFullScreen();
                        } else if (iframeContainer.msRequestFullscreen) {
                            iframeContainer.msRequestFullscreen();
                        }
                    }, 100);
                    iframe.onload = null;
                };
            }
            
            updateStreamInfo();
            resetProgress();
        }
        
        function nextChannel() {
            currentIndex = (currentIndex + 1) % activeStreamers.length;
            loadChannel(currentIndex);
        }
        
        function previousChannel() {
            currentIndex = (currentIndex - 1 + activeStreamers.length) % activeStreamers.length;
            loadChannel(currentIndex);
        }
        
        function togglePlayPause() {
            isPlaying = !isPlaying;
            const btn = document.getElementById('playPauseBtn');
            
            if (isPlaying) {
                btn.textContent = '‚è∏ Pause';
                startInterval();
            } else {
                btn.textContent = '‚ñ∂ Play';
                stopInterval();
            }
        }
        
        function startInterval() {
            stopInterval();
            intervalId = setInterval(nextChannel, intervalSeconds * 1000);
            startProgress();
        }
        
        function stopInterval() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            stopProgress();
        }
        
        function updateInterval() {
            const input = document.getElementById('intervalInput');
            intervalSeconds = Math.max(5, Math.min(600, parseInt(input.value) || 30));
            input.value = intervalSeconds;
            
            if (isPlaying) {
                startInterval();
            }
        }
        
        function startProgress() {
            stopProgress();
            const progressBar = document.getElementById('progressBar');
            let elapsed = 0;
            
            progressBar.style.width = '0%';
            
            progressIntervalId = setInterval(() => {
                elapsed += 0.5;
                const percentage = (elapsed / intervalSeconds) * 100;
                progressBar.style.width = percentage + '%';
                
                if (elapsed >= intervalSeconds) {
                    stopProgress();
                }
            }, 500);
        }
        
        function stopProgress() {
            if (progressIntervalId) {
                clearInterval(progressIntervalId);
                progressIntervalId = null;
            }
        }
        
        function resetProgress() {
            stopProgress();
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = '0%';
            if (isPlaying) {
                startProgress();
            }
        }
        
        // Initialize
        async function initialize() {
            // Fetch stream status first
            await fetchStreamStatus();
            
            // Apply live-only filter if enabled
            if (liveOnlyMode) {
                const liveStreamers = streamers.filter(s => streamStatus[s]?.live);
                if (liveStreamers.length > 0) {
                    activeStreamers = liveStreamers;
                    currentIndex = 0;
                } else {
                    // If no live channels, disable live-only mode
                    liveOnlyMode = false;
                    document.getElementById('liveOnlyCheckbox').checked = false;
                }
            }
            
            loadChannel(currentIndex);
            startInterval();
        }
        
        initialize();
        
        // Update stream status every 60 seconds
        setInterval(fetchStreamStatus, 60000);
        
        // Handle visibility changes to pause when tab is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isPlaying) {
                stopInterval();
            } else if (!document.hidden && isPlaying) {
                startInterval();
            }
        });
        
        // Track fullscreen state
        document.addEventListener('fullscreenchange', () => {
            isInFullscreen = !!document.fullscreenElement;
        });
        document.addEventListener('webkitfullscreenchange', () => {
            isInFullscreen = !!document.webkitFullscreenElement;
        });
        document.addEventListener('mozfullscreenchange', () => {
            isInFullscreen = !!document.mozFullScreenElement;
        });
        document.addEventListener('msfullscreenchange', () => {
            isInFullscreen = !!document.msFullscreenElement;
        });
    </script>
</body>
</html>